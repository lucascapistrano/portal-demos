<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Apache Access Log Heatmap</title>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="heatmap.js"></script>
<script src="heatmap-gmaps.js"></script>
<script src="../portal-1.0rc2.js"></script>
<script src="../portal-extension.js"></script>

<style>
.smallmap {
	width: 700px;
	height: 400px;
}

.olControlAttribution {
	bottom: 0.5em !important;
}
</style>

<script type="text/javascript">
	function init() {

		var myLatlng = new google.maps.LatLng(48.3333, 16.35);
		// sorry - this demo is a beta
		// there is lots of work todo
		// but I don't have enough time for eg redrawing on dragrelease right now
		var myOptions = {
			zoom: 2,
			center: myLatlng,
			mapTypeId: google.maps.MapTypeId.ROADMAP,
			disableDefaultUI: false,
			scrollwheel: true,
			draggable: true,
			navigationControl: true,
			mapTypeControl: false,
			scaleControl: true,
			disableDoubleClickZoom: false
		};
		var map = new google.maps.Map(document.getElementById("map"), myOptions);
		var heatmap = new HeatmapOverlay(map, {
			"radius": 15,
			"visible": true,
			"opacity": 60
		});

		var transports = [ "sse", "stream", "longpoll" ];
		if (!window.location.search || window.location.search.indexOf('nows') === -1) {
			transports.unshift("ws");
		}

		google.maps.event.addListenerOnce(map, "idle", function() {
			portal.open("../tail", {
				sharing: false,
				transports: transports
			}).on({
				latlng: function(data) {
					if (data.max) {
						heatmap.setDataSet({
							max: data.max,
							data: data.data
						});
					} else {
						heatmap.addDataPoint(data.lat, data.lng, 1);
					}
				}
			})
		});

	}
</script>
</head>
<body onload="init()">
	<h1 id="title">Apache Access Log Heatmap</h1>
	<div id="map" class="smallmap"></div>
</body>
</html>